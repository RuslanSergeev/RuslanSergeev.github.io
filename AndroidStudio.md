#Android studio и проект под Android

### Проблемы во время сборки
1. Не настроен NDK, сборка  
  Во вкладке с установкой проекта ставим NDK

2. NDK не настроена версия, сборка  
  смотрим версию в AndroidStudio/Sdk/Ndk и прописываем её build.gradle
  в переменную ndkVersion.

3. нет доступа к dev/kvm при запуске эмулятора  
  даём доступ chmod a+rwx /dev/kvm

4. Ошибка 256  
  поставил дрова nvidia, cuda10.2 вместо драйверов nouveau в software update
  center.

5. Отсутствует libzip.   
скачал libzip из исходников, в поддиректории android модифицировал скрипт do.sh
для сборки с новым ***android-toolchain*** - прописать пути к тулчейну.

6. после динамической линковки с libzip приложение падает в рантайме  
 ***решение 1:***    
 линкуем статически. Однако, AndroidStudio предупреждает,
  что в процессе использования такой библиотеки могут появиться проблемы.   
 ***решение 2:***    
 Копируем библиотеку в jniLibs пректа,
 в CMake IMPORTED_LOCATION прописываем   
 относительный путь до app/src/main/jniLibs/{arch}/libzip.so
 Для ABI x86 линковщик всё равно линкует библиотеку статически, потому что сама
 платформа x86 не поддерживает динамическую линковку.

7. Невозможно слинковать object-libraries компонентов asr вместе с native-библиотекой
на Kotlin.  
  ***решение 1***  
  надо линковать в динамическую asr не через промежуточные object-libraries
  а все исходники одним куском в одну динамическую библиотеку.  
  ***решение 2*** (используется)  
  для всех промежуточных object-libraries сделать   

  `set_target_properties(trgt PROPERTIES POSITION_INDEPENDENT_CODE ON)`

  ***Почему раньше всё работало без POSITION_INDEPENDENT_CODE***  
  при линковке нативной интерфейсной библиотеки как статической (и zip, asr
  также прилинковываются статически), приложение вылетает - т.е. можем линковать
  нативные библиотеки только динамически.
  Если линковать нативную библиотеку динамически, не можем прилинковать к ней
  asr статически - ругается линковщик, на то что символы определенные в
  статической библиотеке не могут быть relocatable. Т.е. asr также должна быть
  слинкована динамически. object-библиотеки для подмодулей
  из asr (pipeline, dec, recognition, dnet, base, lm) состоят из объектных файлов
  и также не могут быть прилинкованы к динамической библиотеке по отдельности.  
  ранее object-libraries линковались в статическую библиотеку asr, так как не было
  требований к её динамичности, а та линковалась непосредственно в исполняемый файл.

8. ***programm invocation short name*** из errno.h не найден.  
в функциях журналирования log_t.  
   ***решение***   
   быстрый фикс - заменить на константную строку, например android_logg.

9. невозможно открыть файл на sd-карте для чтения.  
   ***решение***  
   1. Прописать запрос на доступ в файле манифеста **AndroidManifest.xml**  
   `<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>`
   2. Запросить доступ в рантайме:  
   `requestPermissions(list.toTypedArray(), 123);`
   3. ... не помогло


10. билд релизной версии
   ***решение***
   1. добавить release build type
```
   buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
```
   2. Создать цифровую подпись.
```
   Build->Generate Signed Bundle ... далее по диалогу.
```
   3. Установить .apk на устройство
```
sudo adb install -r ./app/release/app-release.apk
```


## Результаты тестирования
```
===============================================================================
set(CMAKE_CXX_FLAGS "-O0 -fopenmp -fPIC -Wall -mfloat-abi=hard -mfpu=none")
================================================MODEL LOAD
average: 41.447960% len: 25.122914
================================================ASR FILE DECODING
average: 58.551877% len: 35.490136
================================================PCM LOG
average: 0.005224% len: 0.003166
================================================DNET PROCESS
average: 54.945575% len: 33.304243
===============================================================================
set(CMAKE_CXX_FLAGS "-O3 -fopenmp -fPIC -Wall -mfloat-abi=hard -mfpu=neon")
================================================MODEL LOAD
average: 41.894840% len: 24.568878
================================================ASR FILE DECODING
average: 58.105029% len: 34.075207
================================================PCM LOG
average: 0.004102% len: 0.002406
================================================DNET PROCESS
average: 54.409782% len: 31.908160
===============================================================================
```


<div align="center">
<br><br><br>
<a href="index.md">Домой</a>
</div>
